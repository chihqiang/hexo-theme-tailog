<div id="searchOverlay" class="overlay hidden"></div>
<div id="inputContainer" class="floating-search hidden">
  <div class="rounded-lg shadow-lg">
    <input
      type="text"
      id="inputField"
      placeholder="关键词搜索"
      class="w-full px-6 py-3 rounded-full focus:outline-none"
      aria-label="输入框"
    />
    <div id="articleList" class="mt-4 space-y-2"></div>
  </div>
</div>

<script>
  // 文章数组，从服务端传入数据生成
  const articles = [
    <% posts.each(function(post, index){ %>
      {
        title: "<%- post.title.replace(/"/g, '\\"') %>",
        url: "<%= url_for(post.path) %>"
      }<%= index < posts.length - 1 ? ',' : '' %>
    <% }) %>
  ];

  function setupInputHandler() {
    const inputField = document.getElementById("inputField");
    const articleList = document.getElementById("articleList");
    const searchOverlay = document.getElementById("searchOverlay");
    const inputContainer = document.getElementById("inputContainer");

    // 假设页面有一个触发按钮id为searchButton
    const searchButton = document.getElementById("searchButton");
    if (searchButton) {
      searchButton.addEventListener("click", () => {
        inputContainer.classList.remove("hidden");
        inputContainer.classList.add("fade-in");
        inputContainer.classList.remove("fade-out");
        searchOverlay.classList.remove("hidden");
        inputField.focus();
      });
    }

    function hideSearch() {
      inputContainer.classList.add("fade-out");
      setTimeout(() => {
        inputContainer.classList.add("hidden");
        inputContainer.classList.remove("fade-in");
        searchOverlay.classList.add("hidden");
      }, 300);
    }

    searchOverlay.addEventListener("click", hideSearch);

    // 监听 ESC 关闭搜索框和遮罩
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        hideSearch();
      }
    });

    let debounceTimer;
    inputField.addEventListener("input", function () {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const keyword = this.value.toLowerCase();
        if (keyword === "") {
          articleList.innerHTML = "";
          return;
        }
        const filteredArticles = articles
          .filter(article => article.title.toLowerCase().includes(keyword))
          .slice(0, 10);

        const directions = ["fromTop", "fromBottom", "fromLeft", "fromRight"];
        articleList.innerHTML =
          filteredArticles.length > 0
            ? filteredArticles.map((article, index) => `
              <div class="mb-2 animate-article" style="animation-name: ${directions[index % directions.length]}">
                <a href="${article.url}" class="text-blue-600 hover:underline">${article.title}</a>
              </div>`).join("")
            : '<p class="text-gray-500">抱歉，未找到相关内容，换个关键词试试？</p>';
      }, 300);
    });
  }

  document.addEventListener("DOMContentLoaded", setupInputHandler);
</script>
